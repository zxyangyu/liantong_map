<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE"/>
    <!--    <link rel="stylesheet" href="css/index.css" />-->
    <!--    <script type="text/javascript" src="Plugins/jquery-easyui/jquery.min.js"></script>-->
    <script type="text/javascript" src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>


    <script>
        function goBackProMap() {
            $('#cont_pro_map').css('display', 'block');
            $('#cont_city_map').css('display', 'none');
            $('.retPro').css('display', 'none');
        }
    </script>
</head>
<body>
<div id="main" style="width: 100%;height:800px;color: #333;z-index: 1"></div>
<div id="city" style="width: 100%;height:800px;color: #333;z-index: 99"></div>
<script>
    $().ready(function () {
        /*echarts*/
        var ali_map = 'https://geo.datav.aliyun.com/areas_v3/bound/'
        var cdn_url = 'https://cdn.jsdelivr.net/gh/zxyangyu/liantong_map/city_geo/'
        $.get(cdn_url + '440000_full.json', function (mapJson) {
            $.get('../data/result.json').done(function (points) {
                $.get('../data/result_agg.json').done(function (agg) {
                    echarts.registerMap('guang_dong', mapJson);
                    var chart = echarts.init(document.getElementById('main'));//在id为mainMap的dom元素中显示地图
                    var myChartCity
                    var code_city_dict = {
                        'CN-44-53': '云浮市',
                        'CN-44-52': '揭阳市',
                        'CN-44-51': '潮州市',
                        'CN-44-20': '中山市',
                        'CN-44-19': '东莞市',
                        'CN-44-18': '清远市',
                        'CN-44-17': '阳江市',
                        'CN-44-16': '河源市',
                        'CN-44-15': '汕尾市',
                        'CN-44-14': '梅州市',
                        'CN-44-13': '惠州市',
                        'CN-44-12': '肇庆市',
                        'CN-44-09': '茂名市',
                        'CN-44-08': '湛江市',
                        'CN-44-07': '江门市',
                        'CN-44-06': '佛山市',
                        'CN-44-05': '汕头市',
                        'CN-44-04': '珠海市',
                        'CN-44-03': '深圳市',
                        'CN-44-02': '韶关市',
                        'CN-44-01': '广州市'
                    }
                    var city_code_dict = {
                        '云浮市': '445300',
                        '揭阳市': '445200',
                        '潮州市': '445100',
                        '中山市': '442000',
                        '东莞市': '441900',
                        '清远市': '441800',
                        '阳江市': '441700',
                        '河源市': '441600',
                        '汕尾市': '441500',
                        '梅州市': '441400',
                        '惠州市': '441300',
                        '肇庆市': '441200',
                        '茂名市': '440900',
                        '湛江市': '440800',
                        '江门市': '440700',
                        '佛山市': '440600',
                        '汕头市': '440500',
                        '珠海市': '440400',
                        '深圳市': '440300',
                        '韶关市': '440200',
                        '广州市': '440100'
                    }

                    var convertJson = function (data, city) {
                        var res = [];
                        for (var i = 0; i < data.length; i++) {
                            if (code_city_dict[data[i].city] === city) {
                                res.push({
                                    name: data[i].imei,
                                    value: [data[i].lng, data[i].lat]
                                });
                            }
                        }
                        console.log(res);
                        return res;
                    };
                    var convertAgg = function (data, type_column) {
                        var res = [];
                        for (var i = 0; i < data.length; i++) {
                            if (data[i].zone_name === null) {
                                res.push({
                                    name: code_city_dict[data[i].city],
                                    value: data[i][type_column]
                                });
                            } else {
                                res.push({
                                    name: data[i].zone_name,
                                    value: data[i][type_column]
                                });
                            }
                        }
                        console.log(res);
                        return res;
                    }
                    chart.setOption({
                        tooltip: {
                            trigger: 'item',
                            formatter: function loadData(result) {
                                return result.name + '<br />用户数:' + result.value;
                            }
                        },
                        dataRange: {
                            min: 0,
                            max: 50,
                            splitNumber: 0,
                            text: ['高', '低'],
                            calculable: false,
                            selectedMode: false,
                            realtime: false,
                            itemWidth: 10,
                            itemHeight: 60,
                            color: ['lightskyblue', '#f2f2f2']
                        },
                        title: {
                            text: '广东省各市区数据总览',
                            //subtext:'',
                            x: 'center',
                            y: 'top',
                            textAlign: 'left'
                        },
                        series: [{
                            type: 'map',
                            map: 'guang_dong',//要和echarts.registerMap（）中第一个参数一致
                            // scaleLimit: {min: 0.8, max: 1.9},//缩放
                            zoom: 1, //当前视角的缩放比例
                            roam: false, //是否开启平游或缩放

                            mapLocation: {
                                y: 60
                            },
                            // itemStyle: {
                            //     emphasis: {label: {show: false}}
                            // },
                            label: {
                                normal: {
                                    show: true
                                },
                                emphasis: {
                                    show: true
                                }
                            },
                            data: convertAgg(agg, "zone_adcode")
                        }]
                    })

                    chart.on('click', function (result) {//回调函数，点击时触发，参数params格式参加官方API
                        $('#city').css('display', 'block');
                        $('#main').css('display', 'None');
                        // 清空实例重新渲染
                        if (myChartCity) {
                            myChartCity.dispose();
                        }
                        //选择地级市的单击事件
                        var selectCity = result.name;

                        //    调取后台数据
                        $.get(cdn_url + city_code_dict[selectCity] + '_full.json', function (Citymap) {
                            echarts.registerMap(selectCity, Citymap);
                            myChartCity = echarts.init(document.getElementById('city'));
                            myChartCity.setOption({
                                // backgroundColor: '#046486',
                                geo: {
                                    map: selectCity,
                                    roam: false,
                                    label: {show: false},
                                    // 定义样式
                                    itemStyle: {
                                        label: {show: false},
                                        // 普通状态下的样式
                                        normal: {
                                            areaColor: '#ABCDEF99',
                                            borderColor: '#fff'
                                        },
                                        // 高亮状态下的样式,默认黄色
                                        emphasis: {
                                            areaColor: 'white'
                                        }
                                    },
                                    emphasis: {
                                        label: {show: false}
                                    }
                                },
                                toolbox: {
                                    show: true,
                                    orient: 'vertical',
                                    left: 'left',
                                    top: 'center',
                                    itemSize: 25,
                                    feature: {
                                        saveAsImage: {},
                                        myTool: {
                                            show: true,
                                            title: '返回广东省',
                                            icon: 'path://M512 53.333333c253.312 0 458.666667 205.354667 458.666667 458.666667S765.312 970.666667 512 970.666667 53.333333 765.312 53.333333 512 258.688 53.333333 512 53.333333z m199.296 217.770667L409.6 391.786667a32 32 0 0 0-17.813333 17.813333l-120.682667 301.696c-10.453333 26.133333 15.466667 52.053333 41.6 41.6L614.4 632.213333a32 32 0 0 0 17.813333-17.813333l120.682667-301.696c10.453333-26.133333-15.466667-52.053333-41.6-41.6z m-229.461333 210.730667a42.666667 42.666667 0 1 1 60.330666 60.330666 42.666667 42.666667 0 0 1-60.330666-60.330666z',
                                            onclick: function () {
                                                $('#city').css('display', 'None');
                                                $('#main').css('display', 'block');
                                            }
                                        },
                                    },
                                    iconStyle: {
                                        normal: {
                                            color: '#fff'
                                        }
                                    },
                                },
                                tooltip: {
                                    trigger: 'item',
                                    formatter: function loadData(result) {
                                        return result.name + '<br />用户人数:' + result.value;
                                    }
                                },
                                title: {
                                    text: selectCity + '地图数据总览',
                                    x: 'center',
                                    y: 'top',
                                    textAlign: 'left'
                                },
                                series: [
                                    {
                                        type: 'map',
                                        map: selectCity,//要和echarts.registerMap（）中第一个参数一致
                                        geoIndex: 0,
                                        zoom: 1, //当前视角的缩放比例
                                        roam: false, //是否开启平游或缩放
                                        data: convertAgg(agg, "zone_adcode")
                                    },
                                    {
                                        name: 'shanshan',            // series名称
                                        type: 'scatter',          // series图表类型
                                        coordinateSystem: 'geo',  // series坐标系类型
                                        blendMode: 'lighter',   // 叠加效果
                                        symbolSize: 4,
                                        //Scatter才有这个属性,是否开启鼠标 hover 的提示动画效果
                                        hoverAnimation: false,
                                        // data: convertJson(json_data),  // series数据内容
                                        data: convertJson(points, selectCity),  // series数据内容
                                        //控制显示文本
                                        label: {
                                            show: false
                                        },
                                        //series样式
                                        itemStyle: {
                                            color: 'white',
                                            opacity: 0.5,
                                        },
                                        tooltip: {
                                            trigger: 'item',
                                            show: false
                                        },
                                    }
                                ]
                            }, true);
                        });
                    });
                });
            })
        })
    })
    ;
</script>
</body>
</html>